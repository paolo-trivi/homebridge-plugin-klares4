{
    "pluginAlias": "Lares4Complete",
    "pluginType": "platform",
    "singular": true,
    "headerDisplay": "Plugin per il sistema di allarme Ksenia Lares4",
    "footerDisplay": "Per maggiori informazioni visita [GitHub](https://github.com/paolo-trivi/homebridge-plugin-klares4)",
    "schema": {
        "type": "object",
        "properties": {
            "name": {
                "title": "Nome Piattaforma",
                "type": "string",
                "default": "Lares4",
                "required": true
            },
            "ip": {
                "title": "Indirizzo IP",
                "type": "string",
                "format": "ipv4",
                "placeholder": "192.168.1.100",
                "required": true
            },
            "port": {
                "title": "Porta",
                "type": "integer",
                "default": 443,
                "minimum": 1,
                "maximum": 65535,
                "required": true
            },
            "https": {
                "title": "Usa HTTPS",
                "type": "boolean",
                "default": true
            },
            "sender": {
                "title": "Sender ID",
                "type": "string",
                "default": "homebridge",
                "required": true
            },
            "pin": {
                "title": "PIN Sistema",
                "type": "string",
                "required": true
            },
            "debug": {
                "title": "Debug Mode",
                "type": "boolean",
                "default": false
            },
            "maxSeconds": {
                "title": "Timeout Massimo (secondi)",
                "type": "integer",
                "default": 30,
                "minimum": 5,
                "maximum": 300
            },
            "reconnectInterval": {
                "title": "Intervallo Riconnessione (ms)",
                "type": "integer",
                "default": 5000,
                "minimum": 1000,
                "maximum": 60000
            },
            "heartbeatInterval": {
                "title": "Intervallo Heartbeat (ms)",
                "type": "integer",
                "default": 30000,
                "minimum": 10000,
                "maximum": 300000
            },
            "excludeZones": {
                "title": "Zone da Escludere",
                "type": "array",
                "items": {
                    "type": "string"
                }
            },
            "excludeOutputs": {
                "title": "Output da Escludere",
                "type": "array",
                "items": {
                    "type": "string"
                }
            },
            "excludeSensors": {
                "title": "Sensori da Escludere",
                "type": "array",
                "items": {
                    "type": "string"
                }
            },
            "mqtt": {
                "type": "object",
                "properties": {
                    "enabled": {
                        "title": "Abilita MQTT",
                        "type": "boolean",
                        "default": false
                    },
                    "broker": {
                        "title": "Broker MQTT",
                        "type": "string",
                        "placeholder": "mqtt://192.168.1.100:1883",
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "username": {
                        "title": "Username",
                        "type": "string",
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "password": {
                        "title": "Password",
                        "type": "string",
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "clientId": {
                        "title": "Client ID",
                        "type": "string",
                        "placeholder": "homebridge-klares4",
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "topicPrefix": {
                        "title": "Prefisso Topic",
                        "type": "string",
                        "default": "homebridge/klares4",
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "qos": {
                        "title": "QoS",
                        "type": "integer",
                        "default": 1,
                        "enum": [0, 1, 2],
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    },
                    "retain": {
                        "title": "Retain Messages",
                        "type": "boolean",
                        "default": true,
                        "condition": {
                            "functionBody": "return model.mqtt && model.mqtt.enabled === true;"
                        }
                    }
                }
            },
            "roomMapping": {
                "type": "object",
                "properties": {
                    "enabled": {
                        "title": "Abilita Mappatura Stanze",
                        "type": "boolean",
                        "default": false,
                        "description": "Abilita la mappatura dei dispositivi nelle stanze per topic MQTT personalizzati"
                    },
                    "rooms": {
                        "title": "Configurazione Stanze",
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "roomName": {
                                    "title": "Nome Stanza",
                                    "type": "string",
                                    "placeholder": "Es: sala, cucina, camera"
                                },
                                "devices": {
                                    "title": "Dispositivi",
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "deviceId": {
                                                "title": "ID Dispositivo",
                                                "type": "string"
                                            },
                                            "deviceName": {
                                                "title": "Nome Dispositivo",
                                                "type": "string",
                                                "readonly": true
                                            }
                                        },
                                        "required": ["deviceId"]
                                    }
                                }
                            },
                            "required": ["roomName"]
                        },
                        "condition": {
                            "functionBody": "return model.roomMapping && model.roomMapping.enabled === true;"
                        }
                    }
                }
            }
        }
    },
    "layout": [
        {
            "type": "section",
            "title": "Configurazione Connessione",
            "expandable": true,
            "expanded": true,
            "items": [
                "name",
                "ip",
                "port",
                "https",
                "sender",
                "pin"
            ]
        },
        {
            "type": "section",
            "title": "Opzioni Avanzate",
            "expandable": true,
            "expanded": false,
            "items": [
                "debug",
                "maxSeconds",
                "reconnectInterval",
                "heartbeatInterval"
            ]
        },
        {
            "type": "section",
            "title": "Esclusioni Dispositivi",
            "expandable": true,
            "expanded": true,
            "items": [
                {
                    "type": "help",
                    "helpvalue": "<div class='alert alert-primary'><h5>📋 Come Escludere Dispositivi</h5><ol><li><strong>Avvia il plugin una volta</strong> per scoprire tutti i dispositivi</li><li><strong>Controlla il file</strong> <code>~/.homebridge/klares4-devices.json</code></li><li><strong>Copia gli ID</strong> dei dispositivi che NON vuoi vedere in HomeKit</li><li><strong>Incollali</strong> nei campi sottostanti</li><li><strong>Riavvia Homebridge</strong></li></ol></div>"
                },
                {
                    "type": "help",
                    "helpvalue": "<div class='alert alert-info'><h5>💡 Suggerimento</h5><p>Puoi aprire il file <code>klares4-devices.json</code> con un editor di testo per vedere tutti i dispositivi disponibili con i loro ID e nomi.</p><p><strong>Esempio di contenuto del file:</strong></p><pre>{\n  \"outputs\": [\n    {\"id\": \"18\", \"name\": \"Riscaldamento Sala\"},\n    {\"id\": \"31\", \"name\": \"Sirena Esterna\"},\n    ...\n  ]\n}</pre></div>"
                },
                {
                    "key": "excludeOutputs",
                    "type": "array",
                    "orderable": false,
                    "buttonText": "➕ Aggiungi Output da Escludere",
                    "items": [
                        {
                            "type": "div",
                            "displayFlex": true,
                            "flex-direction": "row",
                            "items": [
                                {
                                    "key": "excludeOutputs[]",
                                    "flex": "1 1 50px",
                                    "notitle": true,
                                    "placeholder": "ID Output (es: 18 per Riscaldamento Sala)",
                                    "description": "Inserisci l'ID numerico dell'output da escludere"
                                }
                            ]
                        }
                    ]
                },
                {
                    "key": "excludeZones",
                    "type": "array",
                    "orderable": false,
                    "buttonText": "➕ Aggiungi Zona da Escludere",
                    "items": [
                        {
                            "type": "div",
                            "displayFlex": true,
                            "flex-direction": "row",
                            "items": [
                                {
                                    "key": "excludeZones[]",
                                    "flex": "1 1 50px",
                                    "notitle": true,
                                    "placeholder": "ID Zona (es: 18 per Finestra Studio)",
                                    "description": "Inserisci l'ID numerico della zona da escludere"
                                }
                            ]
                        }
                    ]
                },
                {
                    "key": "excludeSensors",
                    "type": "array",
                    "orderable": false,
                    "buttonText": "➕ Aggiungi Sensore da Escludere",
                    "items": [
                        {
                            "type": "div",
                            "displayFlex": true,
                            "flex-direction": "row",
                            "items": [
                                {
                                    "key": "excludeSensors[]",
                                    "flex": "1 1 50px",
                                    "notitle": true,
                                    "placeholder": "ID Sensore (es: 1 per Term. Sala)",
                                    "description": "Inserisci l'ID numerico del sensore da escludere"
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "type": "section",
            "title": "MQTT Bridge",
            "expandable": true,
            "expanded": false,
            "items": [
                {
                    "type": "help",
                    "helpvalue": "<div class='alert alert-warning'><h5>🚧 Funzionalità Sperimentale</h5><p>Il bridge MQTT permette di:</p><ul><li>📤 <strong>Pubblicare</strong> gli stati degli accessori su MQTT</li><li>📥 <strong>Ricevere</strong> comandi da MQTT per controllare gli accessori</li></ul><p><strong>Formato Topic:</strong></p><ul><li>Stati: <code>homebridge/klares4/{type}/{id}/state</code></li><li>Comandi: <code>homebridge/klares4/{type}/{id}/set</code></li></ul></div>"
                },
                "mqtt.enabled",
                "mqtt.broker",
                "mqtt.username",
                "mqtt.password",
                "mqtt.clientId",
                "mqtt.topicPrefix",
                "mqtt.qos",
                "mqtt.retain"
            ]
        },
        {
            "type": "section",
            "title": "Mappatura Stanze MQTT",
            "expandable": true,
            "expanded": false,
            "items": [
                {
                    "type": "help",
                    "helpvalue": "<div class='alert alert-info'><h5>🏠 Mappatura Stanze MQTT</h5><p>Organizza i dispositivi per stanza nei topic MQTT:</p><ul><li>🔧 <strong>Disabilitato:</strong> <code>homebridge/klares4/{type}/{id}/state</code></li><li>🏠 <strong>Abilitato:</strong> <code>homebridge/{stanza}/{type}/{id}/state</code></li></ul><p><strong>Esempio:</strong></p><ul><li><code>homebridge/sala/sensor/sensor_temp_1/state</code></li><li><code>homebridge/cucina/light/light_9/state</code></li></ul><p>💡 I dispositivi non assegnati useranno <code>klares4</code> come stanza predefinita.</p></div>"
                },
                {
                    "type": "help",
                    "helpvalue": "<div class='alert alert-primary'><h5>📋 Dispositivi del Tuo Sistema</h5><p>💡 <strong>Il plugin genera automaticamente la lista dei tuoi dispositivi:</strong></p><ol><li><strong>Avvia il plugin</strong> una volta per scoprire tutti i dispositivi</li><li><strong>Controlla i log</strong> per vedere l'elenco completo con ID e nomi</li><li><strong>Apri i file generati:</strong><ul><li><code>~/.homebridge/klares4-devices.json</code> - Lista completa dispositivi</li><li><code>~/.homebridge/klares4-room-mapping-example.json</code> - Esempio configurazione</li></ul></li><li><strong>Copia gli ID</strong> dai file e usali nei campi sottostanti</li></ol><p><strong>🎯 Vantaggi:</strong></p><ul><li>✅ Lista sempre aggiornata con i tuoi dispositivi reali</li><li>✅ Nomi originali dal sistema Lares4</li><li>✅ Esempio di configurazione pronto all'uso</li><li>✅ Nessun hardcoding - tutto dinamico!</li></ul></div>"
                },
                "roomMapping.enabled",
                {
                    "key": "roomMapping.rooms",
                    "type": "array",
                    "orderable": true,
                    "buttonText": "🏠 Aggiungi Nuova Stanza",
                    "condition": {
                        "functionBody": "return model.roomMapping && model.roomMapping.enabled === true;"
                    },
                    "items": [
                        {
                            "type": "div",
                            "displayFlex": true,
                            "flex-direction": "column",
                            "items": [
                                {
                                    "key": "roomMapping.rooms[].roomName",
                                    "title": "Nome Stanza",
                                    "placeholder": "Es: sala, cucina, camera, studio"
                                },
                                {
                                    "key": "roomMapping.rooms[].devices",
                                    "title": "Dispositivi in questa stanza",
                                    "type": "array",
                                    "orderable": false,
                                    "buttonText": "📱 Aggiungi Dispositivo",
                                    "items": [
                                        {
                                            "type": "div",
                                            "displayFlex": true,
                                            "flex-direction": "column",
                                            "items": [
                                                {
                                                    "key": "roomMapping.rooms[].devices[].deviceId",
                                                    "title": "ID Dispositivo",
                                                    "type": "string",
                                                    "placeholder": "Es: light_9, sensor_temp_1, cover_1, zone_18",
                                                    "description": "Inserisci l'ID del dispositivo (vedi lista sopra per esempi)",
                                                    "pattern": "^(light_|cover_|sensor_temp_|sensor_hum_|sensor_light_|zone_|thermostat_|scenario_)[0-9]+$"
                                                },
                                                {
                                                    "key": "roomMapping.rooms[].devices[].deviceName",
                                                    "title": "Nome Dispositivo",
                                                    "type": "string",
                                                    "readonly": true,
                                                    "description": "Nome automatico basato sull'ID (verrà popolato dal plugin)"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}